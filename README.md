# Инструкция по использованию программного продукта AngryCritic

AngryCritic - инструмент для анализа данных и определения их тональности, на основании заданных параметров и ключевых слов.
## Компоненты программы
- **angrycritic.py** – исполняемый файл;
- **Папка data** – содержит конфигурационные файлы в формате yaml, для настройки работы кода под ваш контекст данных.
	+ **sample.yaml** - образец со структурой для создания конфигурационных файлов под новые типы данных;
	+ **types.yaml** - содержит ключевые слова для определения типа (категории) данных;
	+ **skip.yaml** – массив ключевых слов и словосочетаний, при обнаружении которых обработка данных производиться не будет;
	+ **replace.yaml** – на стадии предобработке текста имеется возможность произвести замену ключевых слов или фраз и внести эти данные в словари различных типов данных, для однозначного и верного определения категории данных;
	+ **mood_keywords_otp.yaml и mood_keywords_fishing.yaml** и т.д. - конфигурационные файлы, содержащие ключевые слова для конкретных категорий данных.


## Список пакетов, необходимых для работы программы
Перед запуском убедитесь, что все необходимые пакеты установлены:
- **yaml**;
- **os**;
- **pandas**;
- **pymorph3**;
- **string**;
- **time**;
- **tqdm**;
- **nltk**.  
Или воспользоватесь командой:
> pip install -r requirements.txt

## Запуск программы
Перед запуском программы, Excel-файл с данными необходимо переименовать в «**data.xlsx**» и поместить в корневой каталог с программой. Данные, по которым необходимо провести анализ, должны находиться в столбце «**А**». По окончанию обработки в данной папке будет создан файл «**data_done.xlsx**». В обработанном файле будут добавлены следующие данные:
- Леммы слов;
- Категория, к которой относятся данные;
- Ключевые слова, на основании которых была определена категория;
- Тональность;
- Ключевые слова, на основании которых была определена тональность;
- Значение index, на основании которого определяется тональность данных (Больше 0 – позитив, меньше 0 – негатив).;
	> Если в анализируемом тексте встречается несколько ключевых слов, то на основании значения их тональности вычисляется значение index (positive +1, negative -1, undef = 0).
- Вкладка с частотой упоминания слов в документе, для помощи в проработке ключей в **types.yaml** для определения категории(типа) данных;
- Вкладки с частотой упоминания слов для каждой категории данных, заданных в файле **types.yaml**.

## Скорость обработки
На ПК с процессором Intel(R) Core(TM) i5-11400, 8Gb RAM - 4000 строк/мин

## Как настроить программу под свои данные
Первичный запуск:
Поместите «**data.xlsx**» в корневой каталог, запустите процесс обработки. По окончанию откройте файл «**data_done.xlsx**», на вкладке **Частотка по документу** будет представлен список слов с частотой их употребления в документе. Проанализируйте данную информацию, выделите основные категории данных в документе и внесите характеризующие их ключи в файл **types.yaml**. Сохраните изменения в файле **types.yaml**.

Запустите повторное выполнение кода, предварительно закрыв файл «**data_done.xlsx**».
В новом документе появятся дополнительные вкладки с названием заданных категорий(типов) в файле **types.yaml**. На вкладках будет содержаться список слов с частотой их употребления в тексте указанной категории(типа) данных. Воспользуйтесь данной информацией для формирования файлов с ключевыми словами для определения тональности - **mood_keywords_xxx.yaml**.

## Подробнее о работе кода
Обработка документа выполняется в 2 этапа:
1. Предварительная обработка - определение типов/категорий информации в данных, пометка данных, которые обрабатываться не будут, замена ключевых слов.
	- В файл **skip.yaml** - добавьте ключи, при обнаружении которых обработка данных производиться не будет (очистка от спама);
	- В файл **types.yaml** следует добавить типа/категории данных и ключевые слова для определния. Важно! название типа/категории должно соответсвовать названию его конфигурационного файла. Например, otp - mood_keywords_otp.yaml.
	 Если однозначно определить категорию по ключевому слову не представляется возможным, то необходимо добавить ключи в категорию **undef**. То есть, будет проводиться дополнительный анализ данных, по ключевым словам, из словаря **presence_kw** и на основании их наличия будет определяться категория данных.
	 Как это работает:
		> Например, ваши данные содержат слово «письмо», по которому определить к какой категории их отнести достаточно трудно. Поэтому в мы его добавляем в словарь 'undef'. Теперь, если в ваших данных содержится слово ‘письмо’ обработчик будет искать наличие других ключевых слов из словаря presence_kw и на основании их наличия будет определять категорию данных. Если ему это не удастся, данные будут помечены как нераспознанные - ‘undef’.
	- Файл **replace.yaml** – на стадии предобработке текста имеется возможность произвести замену ключевых слов или фраз и внести эти данные в словари различных типов данных, для однозначного и верного определения категории данных. Кроме того, с помощью замены можно исключить, данные не имеющие значения, но часто встречающиеся и влияющие на результат (Например, фраза “Отправлено с iPhone”);
			```
			general:
				отправить с ipad:
				отправить с iphone:
				не согласен: не_согласен
				не согласна: не_согласен
			fishing:
				мочь подтвердить: могу_подтвердить
			```
			- general, fishing – категории данных, к которым будут применены правила замены;
			- general – общие правила замены для всех категорий;
			- отправить с ipad – слово или фраза, которую необходимо заменить (если требуется какую-то фразу убрать из текста, после : осталяйте пустое место, как в данном случае);
			- не_согласен – слово или фраза, на что требуется заменить. Заменяйте пробелы на _ для получения единых словосочетаний, которые в последствии можно будет добавить в ключевые слова для определения тональности.
2. Определение тональности исходя из конфигурационных файлов с ключевыми словами.
	Конфигурационные файлы типов/категорий **mood_keywords_otp.yaml и mood_keywords_fishing.yaml** - необходимо заполнить ключевыми словами, дл определения тональности конкретной категории, или создать новый файл под новую категорию.

Тональность может принимать следующие значения:
| Наименование     | Описание                                                      |
|---|---|
| positive	  | при наличии данного слова в тексте тональность положительная |
| negative        | при наличии данного слова в тексте тональность отрицательная |
| near_positive  | при наличии данного ключа в тексте и сопутствующих слов из словаря near перед ключевым в пределах 2 позиций - тональность положительная |
| near_negative   | при наличии данного ключа в тексте и сопутствующих слов из словаря near перед ключевым в пределах 2 позиций - тональность отрицательная |
| presence	   | при наличии данного ключа в тексте, сопутствующих слов из словаря near перед ключевым в пределах 2 позиций, а также при наличии вспомогательных слов из словаря presence - тональность будет определяться исходя из значения ключей presence |

Вспомогательные ключевые слова, которые располагаются в пределах двух позиций перед основным ключевым словом
	+ **near_kw** – в словаре содержится данные о категории и список сопутствующих слов, при наличии или отсутствии которых принимается решении о тональности данных
		> Например, возьмем fishing.yaml, в словаре 'near' в разделе 'negative' имеется слово - «пропустить». Если в данных будет фраза «не пропустить», то указанное выражение будет считаться негативным.
	+ **presence_kw** – словарь содержит ключевые слова, которые будут определять тональность только совместно с near.
		> Например, возьмем fishing.yaml, в словаре 'presence_kw' имеется слово - «удалить». 
		Возьмем условную фразу "Пришло подозрительное письмо, я его удалила". Здесь нам встречается слово "удалить", после чего определяется, есть ли с ним сопуствующая частица или слово из near_kw. В данном случае имеется, далее происходит проверка на наличие слов из словаря presence, на основании которых принимается решении о тональности.


## Пример использования
Имеем файл **data.xlsx** со следующими данными в столбце **A**:
| Текст     |
|---|
| дискорд не работает сегодня |
| сбои в работе discord |
| discord упал |
| сбои дискорд |
| Дискорд попросту не запускается, бесконечная загрузка |
| сбой работы дискорд сегодня |
| дискорд лежит |
| дискорд сбои |
| ркн заблокировал дискорд качайте AmnesiaWG и WARP конфиг к нему, РКН чтоб вы все сдохли там  |
| не запускается discord |
| Капец, тут ещё люди остались которые не знают что его РКН заблокировали |
| Роскомнадзор ответит. |
| Использую приложения для работы и развлечений - РКН ОДУМАЙСЯ |
| ЧТО ДЕЛАЕТ РКН ЗАЧЕМММММ |
| роскомнадзор заблокировал все |
| А ВЫ ДУМАЛИ ПОСЛЕ СХАВАННОЙ вами БЛОКИРОВКИ ЮТУБА РКН ОСТАНОВИТСЯ? ОНИ ЗАБЕРУТ У ВАС ВСЁ. |

Сразу запускаем первичное выполнение программы, по окончанию которого получаем файл data_done.xlsx следующего содержания:
1. Вкладка **Total** - результат обработки:  
| Text | Lemma | Type | Type_Keywords | Mood | Mood_Keywords | Index |
|-----------|-----------|-----------|-----------|-----------|-----------|-----------|
| дискорд не работает сегодня | ['дискорд', 'не', 'работать', 'сегодня'] | undef | [] | undef | [] | 0 |
| сбои в работе discord | ['сбой', 'в', 'работа', 'discord'] | undef | [] | undef | [] | 0 |
| discord упал | ['discord', 'упасть'] | undef | [] | undef | [] | 0 |
| сбои дискорд | ['сбой', 'дискорд'] | undef | [] | undef | [] | 0 |
| Дискорд попросту не запускается, бесконечная загрузка | ['дискорд', 'попросту', 'не', 'запускаться', 'бесконечный', 'загрузка'] | undef | [] | undef | [] | 0 |
| сбой работы дискорд сегодня | ['сбой', 'работа', 'дискорд', 'сегодня'] | undef | [] | undef | [] | 0 |
| дискорд лежит | ['дискорд', 'лежать'] | undef | [] | undef | [] | 0 |
| дискорд сбои | ['дискорд', 'сбой'] | undef | [] | undef | [] | 0 |
| ркн заблокировал дискорд качайте AmnesiaWG и WARP конфиг к нему, РКН чтоб вы все сдохли там | ['ркн', 'заблокировать', 'дискорд', 'качать', 'amnesiawg', 'и', 'warp', 'конфига', 'к', 'он', 'ркн', 'чтоб', 'вы', 'всё', 'сдохнуть', 'там'] | undef | [] | undef | [] | 0 |
| не запускается discord | ['не', 'запускаться', 'discord'] | undef | [] | undef | [] | 0 |
| Капец, тут ещё люди остались которые не знают что его РКН заблокировали💀 | ['капец', 'тут', 'ещё', 'человек', 'остаться', 'который', 'не', 'знать', 'что', 'он', 'ркн', 'заблокировали💀'] | undef | [] | undef | [] | 0 |
| Роскомнадзор ответит. | ['роскомнадзор', 'ответить'] | undef | [] | undef | [] | 0 |
| Использую приложения для работы и развлечений - РКН ОДУМАЙСЯ | ['использовать', 'приложение', 'для', 'работа', 'и', 'развлечение', 'ркн', 'одуматься'] | undef | [] | undef | [] | 0 |
| ЧТО ДЕЛАЕТ РКН ЗАЧЕМММММ | ['что', 'делать', 'ркн', 'зачеммммм'] | undef | [] | undef | [] | 0 |
| А ВЫ ДУМАЛИ ПОСЛЕ СХАВАННОЙ вами БЛОКИРОВКИ ЮТУБА РКН ОСТАНОВИТСЯ? ОНИ ЗАБЕРУТ У ВАС ВСЁ. | ['а', 'вы', 'думать', 'после', 'схаванна', 'вы', 'блокировка', 'ютуба', 'ркн', 'остановиться', 'они', 'забрать', 'у', 'вы', 'всё'] | undef | [] | undef | [] | 0 |

2. Вкладка **Частотка по документу** - частота использования слов в документе. Данная информация помогает в понимании предмета документа:  
| Слово | Частота |
|---|---|
| дискорд | 7 |
| ркн | 6 |
| сбой | 4 |
| работа | 3 |
| discord | 3 |
| сегодня | 2 |
| запускаться | 2 |
| всё | 2 |
| роскомнадзор | 2 |
| заблокировать | 2 |

Анализируем наиболее часто встречающиеся слова на предмет отнесения к той или иной категории данных или созданию новой.
Из полученной выше информации выделяем тип/категорию данных discord и blocked, и добавляем соответсвующие ключи в файл **/data/types.yaml**
> discord:
	- дискорд
	- discord
> blocked:
  	- ркн
  	- роскомнадзор

После сохранения изменений в файле **types.yaml** можем повторно запустить обработку, предварительно закрыв файл **data_done.xlsx**. По окончанию обработки получим обновленный файл **data_done.xlsx**, в котором будут содержаться новые вкладки **discord** и **blocked**. На данных вкладках будет находиться частотность употребляемых слов только данной категории данных.
Для вкладки **discord**:
| Слово | Частота |
|---|---|
| дискорд | 7 |
| сбой | 4 |
| discord | 3 |
| сегодня | 2 |
| работа | 2 |
| запускаться | 2 |
| ркн | 2 |

Для вкладки **blocked**:
| Слово | Частота |
|---|---|
| ркн | 4 |
| роскомнадзор | 2 |
| всё | 2 |
| капец | 1 |
| заблокировать | 1 |
| блокировка | 1 |

На основании анализа данных вкладок создаем файлы ключевых слов в папке data для определения тональности **mood_keywords_discord.yaml** и **mood_keywords_blocked.yaml** соответсвенно. 

1. **mood_keywords_discord.yaml** 
В раздел negative добавим слова, при наличии которых будем считать негативным - сбой, заблокировать, упасть, сдохнуть.
В раздел near - negative добавляем слова, которые при наличии перед ним частиц из near_kw свидетельствуют о негативном тоне. В данном случае - запускаться, работать, а в near_kw - не ("не запускается", "не работает").

> ---
	positive:
		- 
	negative:
  		- сбой
  		- заблокировать
  		- упасть
  		- сдохнуть
		- лежать
	near:
  		- positive:
    		-
  		- negative:
    		- запускаться
    		- работать
  		- near_kw:
    		- не
	presence_kw:
  		-
	presence:
  		- positive:
    		-
  		- negative:
    		-

Аналогично для других типов.
Далее запускаем выполнение кода еще раз. На вкладке **Total** видим результат добавления ключевых слов и можем оценить корректность работы кода
| Text | Lemma | Type | Type_Keywords | Mood | Mood_Keywords | Index |
|-----------|-----------|-----------|-----------|-----------|-----------|-----------|
| дискорд не работает сегодня  | ['дискорд', 'не', 'работать', 'сегодня'] | discord | ['дискорд'] | negative | ['не + работать'] | -1 |
| сбои в работе discord  | ['сбой', 'в', 'работа', 'discord'] | discord | ['discord', 'сбой'] | negative | ['сбой'] | -1 |
| discord упал  | ['discord', 'упасть'] | discord | ['discord'] | negative | ['упасть'] | -1 |
| сбои дискорд  | ['сбой', 'дискорд'] | discord | ['дискорд', 'сбой'] | negative | ['сбой'] | -1 |
| Дискорд попросту не запускается, бесконечная загрузка  | ['дискорд', 'попросту', 'не', 'запускаться', 'бесконечный', 'загрузка'] | discord | ['дискорд', 'запускаться'] | negative | ['не + запускаться'] | -1 |
| сбой работы дискорд сегодня  | ['сбой', 'работа', 'дискорд', 'сегодня'] | discord | ['дискорд', 'сбой'] | negative | ['сбой'] | -1 |
| дискорд лежит  | ['дискорд', 'лежать'] | discord | ['дискорд'] | negative | ['лежать'] | -1 |
| дискорд сбои  | ['дискорд', 'сбой'] | discord | ['дискорд', 'сбой'] | negative | ['сбой'] | -1 |
| ркн заблокировал дискорд качайте AmnesiaWG и WARP конфиг к нему, РКН чтоб вы все сдохли там  | ['ркн', 'заблокировать', 'дискорд', 'качать', 'amnesiawg', 'и', 'warp', 'конфига', 'к', 'он', 'ркн', 'чтоб', 'вы', 'всё', 'сдохнуть', 'там'] | discord | ['дискорд', 'ркн', 'заблокировать'] | negative | ['заблокировать'] | -1 |
| не запускается discord  | ['не', 'запускаться', 'discord'] | discord | ['discord', 'запускаться'] | negative | ['не + запускаться'] | -1 |
| Капец, тут ещё люди остались которые не знают что его РКН заблокировали💀  | ['капец', 'тут', 'ещё', 'человек', 'остаться', 'который', 'не', 'знать', 'что', 'он', 'ркн', 'заблокировали💀'] | blocked | ['ркн'] | undef | [] | 0 |
| Роскомнадзор ответит.  | ['роскомнадзор', 'ответить'] | blocked | ['роскомнадзор'] | undef | [] | 0 |
| Использую приложения для работы и развлечений - РКН ОДУМАЙСЯ  | ['использовать', 'приложение', 'для', 'работа', 'и', 'развлечение', 'ркн', 'одуматься'] | blocked | ['ркн'] | undef | [] | 0 |
| ЧТО ДЕЛАЕТ РКН ЗАЧЕМММММ  | ['что', 'делать', 'ркн', 'зачеммммм'] | blocked | ['ркн'] | undef | [] | 0 |
| роскомнадзор заблокировал все | ['роскомнадзор', 'заблокировать', 'всё'] | blocked | ['роскомнадзор', 'заблокировать'] | negative | ['заблокировать'] | -1 |
| А ВЫ ДУМАЛИ ПОСЛЕ СХАВАННОЙ вами БЛОКИРОВКИ ЮТУБА РКН ОСТАНОВИТСЯ? ОНИ ЗАБЕРУТ У ВАС ВСЁ.  | ['а', 'вы', 'думать', 'после', 'схаванна', 'вы', 'блокировка', 'ютуба', 'ркн', 'остановиться', 'они', 'забрать', 'у', 'вы', 'всё'] | blocked | ['ркн', 'блокировка'] | undef | [] | 0 |
